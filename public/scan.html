<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Yoklama • Scan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:680px;margin:24px auto;padding:0 12px}
    input,button{font-size:18px;padding:10px;width:100%;box-sizing:border-box}
    .row{display:flex;gap:8px}
    .ok{color:#0a0}.err{color:#c00}.muted{color:#666}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:16px 0}
    .big{font-size:20px}
  </style>
</head>
<body>
  <h2>Yoklama</h2>

  <div class="card">
    <div class="muted">Kod</div>
    <input id="code" placeholder="(otomatik dolar)" />
    <div class="muted" style="margin-top:8px">Öğrenci Numarası</div>
    <input id="studentNo" placeholder="Örn: 20123456" inputmode="numeric" />
    <div class="muted" style="margin-top:8px">Ad Soyad (opsiyonel)</div>
    <input id="name" placeholder="(Opsiyonel)" />
    <div class="row" style="margin-top:12px">
      <button id="submitBtn">Gönder</button>
    </div>
    <div id="msg" class="big" style="margin-top:10px"></div>
  </div>

<script>
(async function(){
  const u = new URL(location.href);
  const codeFromUrl = u.searchParams.get('code');
  const auto = u.searchParams.get('auto') === '1';

  const codeInput = document.getElementById('code');
  const snoInput  = document.getElementById('studentNo');
  const nameInput = document.getElementById('name');
  const msg = document.getElementById('msg');

  // 1) Kod: URL → yoksa sunucudaki aktif kod
  if (codeFromUrl) codeInput.value = codeFromUrl;
  else {
    try { const a = await (await fetch('/api/active-code')).json(); if (a.code) codeInput.value = a.code; } catch {}
  }

  // 2) Öğrenciyi sunucudan tanı (deviceId → studentNo map). Yoksa localStorage.
  try {
    const d = await (await fetch('/api/device')).json();
    if (d?.info?.studentNo) {
      snoInput.value = d.info.studentNo;
      if (d.info.name && !nameInput.value) nameInput.value = d.info.name;
    } else {
      const savedNo = localStorage.getItem('studentNo');
      if (savedNo && !snoInput.value) snoInput.value = savedNo;
    }
  } catch {}

  async function send(){
    const code = (codeInput.value||'').trim();
    const studentNo = (snoInput.value||'').trim();
    const name = (nameInput.value||'').trim();
    if (!code) { msg.textContent='Kod yok'; msg.className='err'; return; }
    if (!studentNo) { msg.textContent='Öğrenci numarası gerekli'; msg.className='err'; return; }

    // localStorage yedek (sunucu zaten map tutuyor)
    localStorage.setItem('studentNo', studentNo);

    msg.textContent='Gönderiliyor...'; msg.className='muted';
    try{
      const r = await fetch('/api/check-in', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ code, studentNo, name })
      });
      const data = await r.json();
      if (data.status === 'success') {
        msg.textContent='Başarılı: yoklama alındı ✅'; msg.className='ok';
        codeInput.disabled = snoInput.disabled = nameInput.disabled = true;
      } else if (data.status === 'already_checked') {
        msg.textContent='Bu kod için zaten yoklama verdiniz ✅'; msg.className='ok';
        codeInput.disabled = snoInput.disabled = nameInput.disabled = true;
      } else {
        msg.textContent='Hata: '+(data.message||data.status); msg.className='err';
      }
    }catch{ msg.textContent='Sunucu hatası'; msg.className='err'; }
  }

  // QR ile geldiyse ve öğrenci tanındıysa otomatik gönder
  if (auto && codeInput.value && (snoInput.value)) {
    setTimeout(send, 300);
  }

  document.getElementById('submitBtn').onclick = (e)=>{ e.preventDefault(); send(); };
  [codeInput, snoInput, nameInput].forEach(el => el.addEventListener('keydown', ev=>{
    if (ev.key === 'Enter') { ev.preventDefault(); send(); }
  }));
})();
</script>
</body>
</html>
